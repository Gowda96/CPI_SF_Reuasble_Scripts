/*

Link to Groovy CPI editor.

https://groovyide.com/cpi/share/v1/xVhtb9s2EP4rnBDETq3ISrJ-mDuvyFJnC-Ckhe0MKKYhYCTK0aoXV6LSBq7_-44voiiJjt1i3dzCkcl7491zz9FeW1G6Kqk1Wlv3WfBkjSzLth4IDkhewOLGtlZ5tiI5jQj7bN0WJL-7CuDZct1T1z07_REULrIypbnUniSrOHsi5G5OMS2Z5Ln9DtavcVri-G5WprCUZrDyW3Y3jR7J3RtMCayduqcvj92zY_flwnVH_D8ITeezN2LTPXZPjt1TfVPabMucNWSygFkPSEyxHt5FjAsW3TVbDEPiUxbLjPhZzs93cTubTW4WLASyBCeTlEaUn3EDaSn8PFrxvPnCfpSsspwiP0ucAq-cJZzpE35yopUDBonjlwXNkoA8OiWNYueaFAVekldeKvX-xo9YbEHa_A-wYdiaRgWFnYCESBpAUB4fHiGFuF-tJeLvEVozKwheTKMu5FgKOEtC36nV_lEtW0KZocrjWofJ9j1Vf8_SpH1R_q60xEVDmED-BTK68i3odPR4yZ5R4_sNrYQDBDDX1arx2NBYZgyTDJJdFR2wDaW4yIOuOIOlIZqpUViDcvPcn4kPxc9ShmODGqw25ClLFMR3ZfCxkHtQQdBBSPNSNYDAvyHH7Q5pGYhZj4gWMSRCayBNr9YOoxTHl1FMSX6RpUHEzjv2LM9qCnX3tQBwQSEZURiRYJtMQXFOWfF2ClzGeDmmeUn4HttCfpnnJKXi-Hw_xHFB9Ba7xquf5zSP0qUt_vzC-CDJUuWvEIe8wQn5A8clQWj8p9CvXp4l2-lteJElK5xCxkZyye6KVhJa_oXQXzsCC8s4ZuB5NiDPqtv1Bj8OyWeQhVJdcNShkdbN-3nlLGxw-2qHnurj5_PnWYK5ICGSwgxh6UgR5gowYunLDAKLKIEztlJeJyV7SgANLClmReVyOLzMcnRZ0jIn6FdAD7Bv3W9o7pMU51FmAqEKTiuI2m3E1o4J-q_I0voJx1dpmLHPmr6WGy8dDs-DAEmX6NND5D8gDBELAKMQzoDjuKYjyOwObDsE-w9r4cTY4KbFQZS-hZAxe-5H1Hlklmx4-ECebJMCUN-mOsGcUMQIFGUab4oAorDPSXqcAu7Rly-Csse9nqTOdZ1LvlOPgXqjGpuFGptPiuVtpiVtyXjqrOJAxIpjSWIFz6cANcpLLgoRKpQ7NLtdgYMLXJD-EYT5fjJnka4VbfK3bV2hZ_67Z5-fGKks1zMO_SCSfXiIGosq5628q9zX0s3NffMva1A9Es7SWxwOhzeZwAyriBjCaNLEzn4BNI7FXzmBnk8rrU5sErhDrSXTRv-P2ZmcorwvOAv2XfvEBR9qnxHNWH0awHyvrr2st6t_CjKoBuWcxEA_SA11VA112C0-RdR_6LduBE1EMigKmz58BvaRl2XgXS0HbSJrw9IwjrtLg_syioN50xRg0-6K2o3M1M3YjEWb3PwAnbGuxj66zwn-oEaTPOrvV_PF29n7xlGNF4tDmvEqHnQoV7etWb68XdzOJnsYDvMs-TrT59Pp_gH_BK_jk9PjsxOT1QZ4K4abwgxEiRyCkuR4R_GBr5MxUETjStuhujeT6eK8VyNMvBuGdhtO5hugcVWAatqxyXBlVGjTO2WPcJRuHjnBMc7rAosjixvhX8zM8ZqP8bp7DUHfcG4EJIGgKp416EY-2u6jK8xkBevXLLPtcvffjyOvnvpGZ_za3538-wcGGTz0vAMB9DEMATTYUogBc2QJFEsuqgfSt_pGOA0Qd-pZ4HywDQXCuUaEqm2J_Oqysx0vb6dTrRu3fG3430o8fMGK3Om1bm3rpy2g4H17tOsMnnVgWucF6R90-0Slf-8byRa3Otye9VO72rwYamTNnDLeoeZbzCTPs5xdY96TgtXbo-L6ohCjs51M8Vdf7k08ws2bYxLqd7WwtQ0S7auWuoKzC5X4EomMFwm5lwKQ5ZdNRtz6ZKiWVexHa41eWsLbmKUtxvzx7kXkIwrAKIUbS0-nZWjdHvv9A7Uh_ByJtN2giu7Bl3C5v0eZwo0pi4bJuX8i-Sj9V3O4pOpEWRgChti5mJvvl8R9XTJHmw4UddKTS4L45AfwGwc3zVSKPNeJY-YA9px-tZ-xohD1ua3XDqgmcFevzsZXx_zdyckqxj45j-M--x3BsuF4Pbun0l5XRrht1GQLcbGXCqg5ICE36kiiZFGKWMZEUEgkrWlu0_zY5Mw93MsZOUDf4rlekMyiTO_Gj9QwKkA_WbYVlqnPam-NLO33e2uz-Qc*/


import com.sap.gateway.ip.core.customdev.util.Message;
import java.util.Stack;

import java.util.List;
def Message processData(Message message) {

    def properties=message.getProperties()
    def userIds=properties.get("User_Ids")
    def country=properties.get("Country")
    def emplStatus=properties.get("Employee_Status")
    def emplClass=properties.get("Employee_Class")
    def manualRun=properties.get("Manual_Run")
    def goLiveDate=properties.get("Go_Live_Date")
    def lsrd=properties.get("LSRD")
    def manualLsrd=properties.get("Manual_LSRD")
    def executionMode=properties.get("Mode")
    def templateId=properties.get("Template_Id")  
    def effectiveRecord=properties.get("Effective_Records")  
    def legalEntity=properties.get("Legal_Entity")  
    
    def finalFilterCondition=""  
    def filterCondition=""
    def lastModifiedCondition=""
    def startDateCondition=""
    def startDateFlag=true
   def  currentRecordFlag=false

    def Map<String,String> commonConditionsFilterNameValue  =[
            "countryOfCompany":country,
            "company":legalEntity
    ]

    def Map<String,String> fullModeFilterNameValue  =[
        "emplStatusNav/externalCode" : emplStatus
    ]

    def Map<String,String> deltaModeFilterNameValue;

    def Map<String,String> manualRunFilterNameValue  =[
         "userId":userIds
    ]

    def lastModifiedFilters=["lastModifiedDateTime",
                "employmentNav/lastModifiedDateTime"]

    //For Future Becomes effective Scenario
    def startDateFilters=[
        "startDate",
        "employmentNav/personNav/personalInfoNav/startDate"
    ]


//Add Filters which are common for all executions
commonConditionsFilterNameValue.each{
    finalFilterCondition=finalFilterCondition+inOperation(it.value,it.key,finalFilterCondition)
}


//Set LSRD of execution
    if(lsrd==null || lsrd=='')
    {
        lsrd=goLiveDate
        message.setProperty("LSRD",lsrd)
    }




//Add additional filters for manual run

if(manualRun.toUpperCase()=='YES')
{    
   
   manualRunFilterNameValue.each{
        finalFilterCondition=finalFilterCondition+inOperation(it.value,it.key,finalFilterCondition)
    } 
    if(manualLsrd !=null && manualLsrd !='')
        {
            lsrd=manualLsrd
            message.setProperty("LSRD",lsrd)
        }
        else
        {
            //No LSRD for Manual Execution
             message.setProperty("LSRD",'')
             return message
        }
    
}

//startDate
def startDate=lsrd.substring(0,10)
startDateTime=startDate+"T00:00:00"




    
    



//Select Effective Records

switch(effectiveRecord.toUpperCase())
{
    case "CURRENT":
         startDateFilters.each{
        startDateCondition=startDateCondition+buildStartDateFilter(it,startDateCondition,startDateTime)
    }
    startDateFlag=false
    currentRecordFlag=true
    break;

    case "HISTORY":
        startDateCondition="&toDate=$startDate"
        break;
    case "FUTURE":
        startDateCondition="&fromDate=$startDate"
        break;
    case "ALL":
        startDateCondition="&toDate=9999-12-31"
        break;

    
}


//Add Last modified filter for delta execution
if(executionMode.toUpperCase()=='DELTA')
{
    
    lastModifiedFilters.each{
        lastModifiedCondition=lastModifiedCondition+buildLastModifiedFilter(it,lastModifiedCondition,lsrd)
    }
	
  if(startDateCondition !='' && currentRecordFlag==true)
  {

lastModifiedCondition= lastModifiedCondition?
                         lastModifiedCondition=lastModifiedCondition +" or "+startDateCondition:
                        startDateCondition
  } 
  


    deltaModeFilterNameValue.each{
        finalFilterCondition=finalFilterCondition+inOperation(it.value,it.key,finalFilterCondition)
    }

    if(finalFilterCondition=="")
    {
        finalFilterCondition=finalFilterCondition+ "&\$filter=(" +  lastModifiedCondition+")" 
   }
    else
    {
        finalFilterCondition=finalFilterCondition+ " and " + "("+   lastModifiedCondition+")"
    }
  
}


else

if(executionMode.toUpperCase()=='FULL')
{
    fullModeFilterNameValue.each{
        finalFilterCondition=finalFilterCondition+inOperation(it.value,it.key,finalFilterCondition)
    }

   /* if(currentRecordFlag)
    {
        
        if(finalFilterCondition!='' ){
        finalFilterCondition="$finalFilterCondition and ($startDateCondition)"
     }
        else
        {
            finalFilterCondition="&\$filter=($startDateCondition)"
        }
    }*/
    
}
else{
	message.setProperty("Error",'Yes')
	return
}


if(startDateFlag)
{
    finalFilterCondition=finalFilterCondition+startDateCondition
}

message.setProperty("Filter_Condition",finalFilterCondition)
return message
}



def String buildStartDateFilter(String name,String curLastModified,String startDate){

    if(curLastModified=="")
    {
        curLastModified=name + " eq datetime'"+startDate+"'"   
        
    }
    else
    {
        curLastModified= " or " + name +" eq datetime'"+startDate+"'"   
    }


}

def String buildLastModifiedFilter(String name,String curLastModified,String lsrd){

    if(curLastModified=="")
    {
        curLastModified=name + " gt datetimeoffset'"+lsrd+"'"   
        
    }
    else
    {
        curLastModified= " or " + name +" gt datetimeoffset'"+lsrd+"'"   
    }
 }


def String inOperation(String value,String fieldName,String curFilter){

    def retValue=""
    if (value?.trim()) {
    value=value.replaceAll(",", "','")
        if(curFilter=="")
            {
                retValue= "&\$filter="+fieldName + " in '"+ value +"'"
            }
            else
            {
                retValue= " and "+ fieldName + " in '"+ value +"'"
            }

        return  retValue
    }
    else
    {
        return retValue
    }
    
}
